<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ELIMENTAL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              primary: {
                50: '#fff5f3',
                100: '#ffeae6',
                200: '#ffd5cc',
                300: '#ffbfb3',
                400: '#ffaa99',
                500: '#ff846b',
                600: '#f56a4f',
                700: '#e05a41',
                800: '#c24a34',
                900: '#a33d2a'
              }
            }
          }
        }
      }
    </script>
    <style>
        body { -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    </style>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "react": "https://esm.sh/react@18.3.1",
        "react-dom/client": "https://esm.sh/react-dom@18.3.1/client"
      }
    }
    </script>
<link rel="stylesheet" href="/index.css">
</head>
<body class="bg-slate-50">
    <div id="root"></div>
    <script type="text/babel" data-type="module">
// React and ReactDOM are imported via the importmap
import React, { useState, useMemo, useEffect, useCallback } from 'react';
import ReactDOM from 'react-dom/client';

// --- START OF INLINED CODE ---

// --- CONSTANTS ---
const ICONS = {
    USER: 'M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z',
    HOME: 'M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z',
    BRIEFCASE: 'M20 6h-4V4c0-1.1-.9-2-2-2h-4c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v11c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zM10 4h4v2h-4V4zm10 15H4V8h16v11z',
    HEART: 'M12 21.35l-1.41-1.41C5.41 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.41 6.86-8.59 11.44L12 21.35z',
    PILL: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-5 13H5v-2h2v2zm0-4H5V9h2v2zm0-4H5V5h2v2zm4 8H9v-2h2v2zm0-4H9V9h2v2zm0-4H9V5h2v2zm4 8h-2v-2h2v2zm0-4h-2V9h2v2zm0-4h-2V5h2v2zm2 4h-2V9h2v2z',
    BOOK: 'M18 2H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 4h5v8l-2.5-1.5L6 12V4z',
    PENCIL: 'M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34a.9959.9959 0 00-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z',
    TRASH: 'M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z',
    CHEVRON_LEFT: 'M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z',
    CHEVRON_RIGHT: 'M8.59 16.59L10 18l6-6-6-6-1.41 1.41L13.17 12z',
    CHEVRON_DOWN: 'M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z',
    CHEVRON_UP: 'M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z',
    CALENDAR: 'M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z',
    CLOCK: 'M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z',
    PLUS: 'M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z',
    CLIPBOARD: 'M19 3h-4.18C14.4 1.84 13.3 1 12 1s-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 16H5V5h2v2h10V5h2v14z',
    INSURANCE: 'M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z',
    USER_PLUS: 'M9 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4zm11-4h-2V7h-2v2h-2v2h2v2h2v-2h2z',
};

const PSYCHIATRIST_SPECIALTIES = [
  'Psiquiatría General',
  'Psiquiatría Infantil y Adolescente',
  'Psicogeriatría',
  'Adicciones',
  'Trastornos de la Conducta Alimentaria',
];

// Polyfill for structuredClone if not available
if (!self.structuredClone) {
    self.structuredClone = (val) => JSON.parse(JSON.stringify(val));
}


// --- COMMON COMPONENTS ---

const Icon = ({ path, className = 'w-6 h-6', ...props }) => (
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className} {...props}>
    <path fillRule="evenodd" d={path} clipRule="evenodd" />
  </svg>
);

const Button = ({ children, variant = 'primary', className = '', ...props }) => {
  const baseClasses = 'inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-colors';
  const variantClasses = {
    primary: 'text-white bg-primary-600 hover:bg-primary-700 focus:ring-primary-500',
    secondary: 'text-primary-700 bg-primary-100 hover:bg-primary-200 focus:ring-primary-500',
    danger: 'text-white bg-red-600 hover:bg-red-700 focus:ring-red-500',
    'danger-secondary': 'text-red-700 bg-red-100 hover:bg-red-200 focus:ring-red-500',
  };
  return (<button type="button" className={`${baseClasses} ${variantClasses[variant]} ${className}`} {...props}>{children}</button>);
};

const Modal = ({ isOpen, onClose, title, children }) => {
  useEffect(() => {
    const handleEsc = (event) => { if (event.key === 'Escape') onClose(); };
    window.addEventListener('keydown', handleEsc);
    return () => window.removeEventListener('keydown', handleEsc);
  }, [onClose]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50" aria-modal="true" role="dialog">
      <div className="relative bg-white rounded-lg shadow-xl w-full max-w-lg mx-4" onClick={(e) => e.stopPropagation()}>
        <div className="flex items-start justify-between p-4 border-b rounded-t">
          <h3 className="text-xl font-semibold text-gray-900">{title}</h3>
          <button type="button" className="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm p-1.5 ml-auto inline-flex items-center" onClick={onClose} aria-label="Cerrar modal">
            <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fillRule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clipRule="evenodd"></path></svg>
          </button>
        </div>
        <div className="p-6 space-y-6">{children}</div>
      </div>
    </div>
  );
};

// --- MAIN COMPONENTS ---

const PatientView = ({ patient, onUpdatePatient, onBack }) => {
  const [currentHistoryNote, setCurrentHistoryNote] = useState('');
  const [currentTreatmentNote, setCurrentTreatmentNote] = useState('');
  const [isEditModalOpen, setIsEditModalOpen] = useState(false);
  const [editablePatientData, setEditablePatientData] = useState(patient);
  
  const [noteToEdit, setNoteToEdit] = useState(null);
  const [confirmation, setConfirmation] = useState(null);

  const InfoCard = ({ icon, title, children, className = '' }) => (
    <div className={`bg-slate-100 p-4 rounded-lg ${className}`}>
        <div className="flex items-center mb-2">
            <Icon path={icon} className="w-5 h-5 text-primary-600 mr-2" />
            <h3 className="text-md font-semibold text-slate-700">{title}</h3>
        </div>
        <div className="text-sm text-slate-600">{children}</div>
    </div>
  );

  const EvolutionSection = ({ title, history, onEdit, onDelete }) => (
    <details className="bg-slate-100 rounded-lg">
        <summary className="p-3 font-medium cursor-pointer text-sm text-primary-700 hover:bg-primary-50 rounded-lg">
            {title}
        </summary>
        <div className="p-3 border-t border-slate-200">
            {history.length > 0 ? (
                <ul className="space-y-4">
                    {[...history].reverse().map((entry, i) => {
                        const originalIndex = history.length - 1 - i;
                        return (
                        <li key={originalIndex} className="text-sm text-slate-600 group relative">
                            <div className="flex justify-between items-start">
                                <div className="pr-12">
                                    <p className="font-semibold">{new Date(entry.date).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                    <p className="pl-2 border-l-2 border-slate-300 ml-1 mt-1 break-words">{entry.note}</p>
                                </div>
                                <div className="absolute top-0 right-0 flex items-center space-x-1 opacity-0 group-hover:opacity-100 focus-within:opacity-100 transition-opacity bg-slate-100 p-1 rounded-bl-md">
                                    <button onClick={() => onEdit(originalIndex)} className="p-1 rounded-full hover:bg-slate-300" aria-label="Editar nota">
                                        <Icon path={ICONS.PENCIL} className="w-4 h-4 text-slate-700" />
                                    </button>
                                    <button onClick={() => onDelete(originalIndex)} className="p-1 rounded-full hover:bg-slate-300" aria-label="Eliminar nota">
                                        <Icon path={ICONS.TRASH} className="w-4 h-4 text-red-600" />
                                    </button>
                                </div>
                            </div>
                        </li>
                    )})}
                </ul>
            ) : ( <p className="text-sm text-slate-500 italic">No hay entradas previas.</p> )}
        </div>
    </details>
  );

  const calculateAge = (dob) => {
    if (!dob) return 0;
    const birthDate = new Date(dob);
    const today = new Date();
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
  };

  const handleSaveConsultation = () => {
    const updatedPatient = structuredClone(patient);
    const today = new Date().toISOString().split('T')[0];

    if (currentHistoryNote.trim()) {
      updatedPatient.consultationHistory.push({ date: today, note: currentHistoryNote.trim() });
    }
    if (currentTreatmentNote.trim()) {
      updatedPatient.treatmentHistory.push({ date: today, note: currentTreatmentNote.trim() });
    }

    onUpdatePatient(updatedPatient);
    onBack();
  };

  const openEditModal = () => {
    setEditablePatientData(structuredClone(patient));
    setIsEditModalOpen(true);
  };
  
  const handleSavePatientDetails = () => {
      onUpdatePatient(editablePatientData);
      setIsEditModalOpen(false);
  }
  
  const handleEditFormChange = (e) => {
    const { name, value } = e.target;
    setEditablePatientData(prev => ({...prev, [name]: value}));
  };

  const handleEditHistoryNote = (type, index) => {
    const historyKey = type === 'treatment' ? 'treatmentHistory' : 'consultationHistory';
    setNoteToEdit({ type, index, note: patient[historyKey][index].note });
  };
  
  const handleSaveEditedNote = () => {
    if (!noteToEdit) return;
    const { type, index, note } = noteToEdit;
    const onConfirm = () => {
      const historyKey = type === 'treatment' ? 'treatmentHistory' : 'consultationHistory';
      const updatedHistory = [...patient[historyKey]];
      updatedHistory[index] = { ...updatedHistory[index], note: note };
      const updatedPatient = { ...patient, [historyKey]: updatedHistory };
      onUpdatePatient(updatedPatient);
      setConfirmation(null);
    };
    setNoteToEdit(null);
    setConfirmation({ message: '¿Está seguro de que desea guardar los cambios en esta nota?', onConfirm });
  };

  const handleDeleteHistoryNote = (type, index) => {
    const onConfirm = () => {
      const historyKey = type === 'treatment' ? 'treatmentHistory' : 'consultationHistory';
      const updatedHistory = patient[historyKey].filter((_, i) => i !== index);
      const updatedPatient = { ...patient, [historyKey]: updatedHistory };
      onUpdatePatient(updatedPatient);
      setConfirmation(null);
    };
    setConfirmation({ message: '¿Está seguro de que desea eliminar esta entrada de la historia?', onConfirm });
  };

  const lastTreatment = [...patient.treatmentHistory].pop();
  const lastConsultation = [...patient.consultationHistory].pop();

  return (
    <div className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <div className="mb-6 flex justify-between items-center">
            <div className="flex items-center gap-4">
                <h1 className="text-3xl font-bold text-slate-800">{patient.name}</h1>
                <Button variant="secondary" onClick={openEditModal} className="p-2 h-10 w-10 !rounded-full">
                    <Icon path={ICONS.PENCIL} className="w-5 h-5"/>
                </Button>
            </div>
            <Button onClick={onBack} variant="secondary">Volver a la Agenda</Button>
        </div>
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div className="space-y-6">
                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <InfoCard icon={ICONS.USER} title="Edad">{calculateAge(patient.dateOfBirth)} años</InfoCard>
                    <InfoCard icon={ICONS.HOME} title="Domicilio">{patient.address}</InfoCard>
                    <InfoCard icon={ICONS.BRIEFCASE} title="Seguro" className="sm:col-span-2">{patient.insurance}</InfoCard>
                    <InfoCard icon={ICONS.HEART} title="Antecedentes Salud Mental" className="sm:col-span-2"><p className="whitespace-pre-wrap">{patient.mentalHealthHistory}</p></InfoCard>
                    <InfoCard icon={ICONS.USER} title="Situación Basal" className="sm:col-span-2"><p className="whitespace-pre-wrap">{patient.baselineSituation}</p></InfoCard>
                    <InfoCard icon={ICONS.PILL} title="Tóxicos" className="sm:col-span-2"><p className="whitespace-pre-wrap">{patient.substanceUse}</p></InfoCard>
                </div>
                <div className="bg-white p-4 rounded-lg shadow">
                    <h2 className="text-xl font-semibold text-slate-800 mb-3">Tratamiento</h2>
                    <div className="mb-4 p-3 bg-primary-50 border-l-4 border-primary-500 rounded">
                        <h3 className="font-semibold text-primary-800">Tratamiento Actual</h3>
                        <p className="text-sm text-primary-700 mt-1">{lastTreatment?.note || 'No hay tratamiento activo registrado.'}</p>
                    </div>
                    <EvolutionSection title="Ver Evolución Previa del Tratamiento" history={patient.treatmentHistory} onEdit={(index) => handleEditHistoryNote('treatment', index)} onDelete={(index) => handleDeleteHistoryNote('treatment', index)}/>
                    <textarea value={currentTreatmentNote} onChange={(e) => setCurrentTreatmentNote(e.target.value)} placeholder="Añadir nueva nota de tratamiento/evolución..." className="mt-4 w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500" rows={3}></textarea>
                </div>
            </div>
            <div className="flex flex-col">
                <div className="bg-white p-4 rounded-lg shadow h-full flex flex-col">
                    <h2 className="text-xl font-semibold text-slate-800 mb-3">Historia Clínica</h2>
                    <div className="mb-4 p-3 bg-slate-100 border-l-4 border-slate-400 rounded">
                        <h3 className="font-semibold text-slate-800">Última Consulta</h3>
                        <p className="text-sm text-slate-700 mt-1">{lastConsultation?.note || 'No hay consultas previas registradas.'}</p>
                    </div>
                    <EvolutionSection title="Ver Evolución Previa de la Historia" history={patient.consultationHistory} onEdit={(index) => handleEditHistoryNote('consultation', index)} onDelete={(index) => handleDeleteHistoryNote('consultation', index)}/>
                    <textarea value={currentHistoryNote} onChange={(e) => setCurrentHistoryNote(e.target.value)} placeholder="Redactar historia actual de la consulta..." className="mt-4 w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 flex-grow min-h-[250px]"></textarea>
                </div>
            </div>
        </div>
        <div className="mt-8 flex justify-end">
            <Button onClick={handleSaveConsultation}>Aceptar y Guardar Consulta</Button>
        </div>
        <Modal isOpen={isEditModalOpen} onClose={() => setIsEditModalOpen(false)} title="Editar Datos del Paciente">
            <div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div><label htmlFor="name" className="block text-sm font-medium text-gray-700">Nombre completo</label><input type="text" name="name" id="name" value={editablePatientData.name} onChange={handleEditFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div>
                    <div><label htmlFor="dateOfBirth" className="block text-sm font-medium text-gray-700">Fecha de Nacimiento</label><input type="date" name="dateOfBirth" id="dateOfBirth" value={editablePatientData.dateOfBirth} onChange={handleEditFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div>
                    <div><label htmlFor="address" className="block text-sm font-medium text-gray-700">Domicilio</label><input type="text" name="address" id="address" value={editablePatientData.address} onChange={handleEditFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div>
                    <div><label htmlFor="insurance" className="block text-sm font-medium text-gray-700">Seguro</label><input type="text" name="insurance" id="insurance" value={editablePatientData.insurance} onChange={handleEditFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div>
                    <div><label htmlFor="clinicalHistoryNumber" className="block text-sm font-medium text-gray-700">Nº Historia Clínica</label><input type="text" name="clinicalHistoryNumber" id="clinicalHistoryNumber" value={editablePatientData.clinicalHistoryNumber} onChange={handleEditFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div>
                </div>
                <div><label htmlFor="mentalHealthHistory" className="block text-sm font-medium text-gray-700">Antecedentes Salud Mental</label><textarea name="mentalHealthHistory" id="mentalHealthHistory" value={editablePatientData.mentalHealthHistory} onChange={handleEditFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md" rows={3}/></div>
                <div><label htmlFor="baselineSituation" className="block text-sm font-medium text-gray-700">Situación Basal</label><textarea name="baselineSituation" id="baselineSituation" value={editablePatientData.baselineSituation} onChange={handleEditFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md" rows={3}/></div>
                <div><label htmlFor="substanceUse" className="block text-sm font-medium text-gray-700">Tóxicos</label><textarea name="substanceUse" id="substanceUse" value={editablePatientData.substanceUse} onChange={handleEditFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md" rows={3}/></div>
            </div>
            <div className="mt-6 flex justify-end"><Button onClick={handleSavePatientDetails}>Guardar Cambios</Button></div>
        </Modal>
        <Modal isOpen={!!noteToEdit} onClose={() => setNoteToEdit(null)} title="Editar Nota de Evolución">
            {noteToEdit && (<div><textarea value={noteToEdit.note} onChange={(e) => setNoteToEdit({ ...noteToEdit, note: e.target.value })} className="mt-2 w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500" rows={8} /><div className="mt-6 flex justify-end gap-2"><Button variant="secondary" onClick={() => setNoteToEdit(null)}>Cancelar</Button><Button onClick={handleSaveEditedNote}>Guardar Cambios</Button></div></div>)}
        </Modal>
        <Modal isOpen={!!confirmation} onClose={() => setConfirmation(null)} title="Confirmar Acción">
            {confirmation && (<div><p className="text-slate-700">{confirmation.message}</p><div className="mt-6 flex justify-end gap-2"><Button variant="secondary" onClick={() => setConfirmation(null)}>Cancelar</Button><Button variant="danger" onClick={confirmation.onConfirm}>Confirmar</Button></div></div>)}
        </Modal>
    </div>
  );
};

const PsychiatristAgenda = ({ appData, onDataChange, onSelectPatient }) => {
  const { psychiatrists, patients, appointments } = appData;
  const [expandedId, setExpandedId] = useState(psychiatrists[0]?.id || null);
  const [selectedDate, setSelectedDate] = useState(new Date());
  
  const [isPsyModalOpen, setIsPsyModalOpen] = useState(false);
  const [editingPsychiatrist, setEditingPsychiatrist] = useState(null);
  const [psyFormData, setPsyFormData] = useState({ name: '', specialty: PSYCHIATRIST_SPECIALTIES[0] });

  const [isAptModalOpen, setIsAptModalOpen] = useState(false);
  const [newAptData, setNewAptData] = useState(null);

  const initialPatientState = { clinicalHistoryNumber: '', name: '', dateOfBirth: '', address: '', insurance: '', mentalHealthHistory: '', baselineSituation: '', substanceUse: '' };
  const [isPatientModalOpen, setIsPatientModalOpen] = useState(false);
  const [newPatientData, setNewPatientData] = useState(initialPatientState);
  
  const [psyToDelete, setPsyToDelete] = useState(null);

  const getDayName = (date) => date.toLocaleDateString('es-ES', { weekday: 'long' });
  const getDayNumber = (date) => date.getDate();

  const handleAddPsychiatrist = (name, specialty) => {
    const newPsychiatrist = { id: `psy-${new Date().getTime()}`, name, specialty };
    onDataChange({ ...appData, psychiatrists: [...psychiatrists, newPsychiatrist] });
  };
  const handleUpdatePsychiatrist = (updated) => {
    const updatedPsychiatrists = psychiatrists.map(p => p.id === updated.id ? updated : p);
    onDataChange({ ...appData, psychiatrists: updatedPsychiatrists });
  };
  const handleDeletePsychiatrist = (id) => {
    const updatedAppointments = appointments.filter(apt => apt.psychiatristId !== id);
    const updatedPsychiatrists = psychiatrists.filter(psy => psy.id !== id);
    onDataChange({ ...appData, appointments: updatedAppointments, psychiatrists: updatedPsychiatrists });
  };
  const handleAddPatient = (data) => {
    const newPatient = { id: `pat-${new Date().getTime()}`, ...data, treatmentHistory: [], consultationHistory: [] };
    onDataChange({ ...appData, patients: [...patients, newPatient] });
  };
  const handleAddAppointment = (data) => {
    const newAppointment = { id: `apt-${new Date().getTime()}`, ...data };
    onDataChange({ ...appData, appointments: [...appointments, newAppointment] });
  };


  const MonthCalendar = ({ selectedDate, onDateSelect }) => {
    const [viewDate, setViewDate] = useState(new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1));
    const changeMonth = (offset) => setViewDate(current => { const newDate = new Date(current); newDate.setMonth(newDate.getMonth() + offset); return newDate; });
    const isSameDay = (d1, d2) => d1.getFullYear() === d2.getFullYear() && d1.getMonth() === d2.getMonth() && d1.getDate() === d2.getDate();
    const today = new Date();

    const renderHeader = () => (<div className="flex items-center justify-between px-2 py-2"><button onClick={() => changeMonth(-1)} className="p-1 rounded-full hover:bg-slate-200" aria-label="Mes anterior"><Icon path={ICONS.CHEVRON_LEFT} className="w-6 h-6 text-slate-600" /></button><h2 className="font-semibold text-slate-800 capitalize" aria-live="polite">{viewDate.toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}</h2><button onClick={() => changeMonth(1)} className="p-1 rounded-full hover:bg-slate-200" aria-label="Mes siguiente"><Icon path={ICONS.CHEVRON_RIGHT} className="w-6 h-6 text-slate-600" /></button></div>);
    const renderDaysOfWeek = () => (<div className="grid grid-cols-7 text-center text-xs text-slate-500 font-medium pb-2">{['L', 'M', 'X', 'J', 'V', 'S', 'D'].map(day => <div key={day}><span className="sr-only">{getDayName(new Date(2024, 0, 1 + ['L', 'M', 'X', 'J', 'V', 'S', 'D'].indexOf(day)))}</span>{day}</div>)}</div>);
    const renderCalendarGrid = () => {
        const year = viewDate.getFullYear(), month = viewDate.getMonth();
        const firstDayOfMonth = (new Date(year, month, 1).getDay() + 6) % 7;
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const cells = Array.from({ length: firstDayOfMonth }, (_, i) => <div key={`pad-${i}`}></div>);
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const isSelected = isSameDay(date, selectedDate), isToday = isSameDay(date, today);
            const classes = `w-9 h-9 flex items-center justify-center rounded-full cursor-pointer text-sm ${isSelected ? "bg-primary-600 text-white font-semibold shadow-md" : `hover:bg-primary-100 ${isToday ? "ring-1 ring-primary-500 text-primary-600" : ""}`}`;
            cells.push(<div key={day} className="flex justify-center items-center p-1"><button onClick={() => onDateSelect(date)} className={classes} aria-pressed={isSelected}><time dateTime={date.toISOString().split('T')[0]}>{day}</time></button></div>);
        }
        return <div className="grid grid-cols-7 gap-y-1">{cells}</div>;
    };
    return (<div className="bg-white p-4 rounded-lg shadow-md">{renderHeader()}{renderDaysOfWeek()}{renderCalendarGrid()}</div>);
  };

  const CalendarView = ({ psychiatristId, onAddAppointment, selectedDate, onDateChange }) => {
    const weekDays = useMemo(() => {
        const startOfWeek = new Date(selectedDate);
        startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay() + (startOfWeek.getDay() === 0 ? -6 : 1));
        return Array.from({ length: 7 }, (_, i) => { const day = new Date(startOfWeek); day.setDate(startOfWeek.getDate() + i); return day; });
    }, [selectedDate]);
    const formatDate = (date) => date.toISOString().split('T')[0];
    const appointmentsForSelectedDay = appointments.filter(apt => apt.psychiatristId === psychiatristId && apt.date === formatDate(selectedDate)).sort((a,b) => a.time.localeCompare(b.time));
    return (
        <div className="bg-slate-50 p-4 rounded-b-lg">
            <div className="grid grid-cols-7 gap-1 text-center mb-4 p-2 bg-white rounded-lg shadow-sm">{weekDays.map(day => (<button key={day.toISOString()} onClick={() => onDateChange(day)} className={`flex flex-col items-center p-2 rounded-lg ${formatDate(day) === formatDate(selectedDate) ? 'bg-primary-600 text-white shadow' : 'hover:bg-primary-100'}`}><span className="text-xs sm:text-sm capitalize">{getDayName(day).substring(0,3)}</span><span className="text-lg sm:text-xl font-bold">{getDayNumber(day)}</span></button>))}</div>
            <div className="space-y-3 min-h-[10rem]">{appointmentsForSelectedDay.length > 0 ? (appointmentsForSelectedDay.map(apt => { const patient = patients.find(p => p.id === apt.patientId); if (!patient) return null; return (<div key={apt.id} onDoubleClick={() => onSelectPatient(patient.id)} className="p-3 bg-white rounded-lg shadow-sm hover:shadow-md hover:border-primary-500 border-l-4 border-transparent cursor-pointer transition-all"><div className="flex items-center justify-between"><div className="flex items-center"><div className="flex items-center mr-4 text-primary-600"><Icon path={ICONS.CLOCK} className="w-5 h-5 mr-2" /><span className="font-bold text-lg">{apt.time}</span></div><div><p className="font-semibold text-slate-800">{patient.name}</p><div className="flex items-center text-xs text-slate-500 mt-1 flex-wrap"><Icon path={ICONS.CLIPBOARD} className="w-4 h-4 mr-1"/> NHC: {patient.clinicalHistoryNumber}<span className="mx-2 hidden sm:inline">|</span><Icon path={ICONS.INSURANCE} className="w-4 h-4 mr-1 sm:ml-0 ml-2"/> {patient.insurance}</div></div></div></div></div>);})) : (<div className="flex justify-center items-center h-full text-center py-8 text-slate-500 italic">No hay citas para este día.</div>)}</div>
            <div className="mt-4 flex justify-end"><Button variant="secondary" onClick={() => onAddAppointment(psychiatristId, formatDate(selectedDate))}><Icon path={ICONS.PLUS} className="w-5 h-5 mr-2" />Añadir Cita</Button></div>
        </div>
    );
  };

  const handleToggle = (id) => setExpandedId(expandedId === id ? null : id);
  const openPsyModal = (psy) => { setEditingPsychiatrist(psy); setPsyFormData(psy ? { name: psy.name, specialty: psy.specialty } : { name: '', specialty: PSYCHIATRIST_SPECIALTIES[0] }); setIsPsyModalOpen(true); };
  const handlePsyFormChange = (e) => setPsyFormData(prev => ({ ...prev, [e.target.name]: e.target.value }));
  const handleSavePsychiatrist = () => { if (psyFormData.name.trim()) { editingPsychiatrist ? handleUpdatePsychiatrist({ ...editingPsychiatrist, ...psyFormData }) : handleAddPsychiatrist(psyFormData.name.trim(), psyFormData.specialty); setIsPsyModalOpen(false); } };
  const openAptModal = (psychiatristId, date) => { setNewAptData({psychiatristId, date, patientId: '', time: ''}); setIsAptModalOpen(true); };
  const handleNewAptSubmit = () => { if (newAptData && newAptData.patientId && newAptData.time) { handleAddAppointment(newAptData); setNewAptData(null); setIsAptModalOpen(false); } };
  const handlePatientFormChange = (e) => setNewPatientData(prev => ({...prev, [e.target.name]: e.target.value}));
  const handleSaveNewPatient = () => { if(newPatientData.name && newPatientData.dateOfBirth && newPatientData.clinicalHistoryNumber) { handleAddPatient(newPatientData); setIsPatientModalOpen(false); setNewPatientData(initialPatientState); } else { alert('Por favor, complete al menos el Nombre, Fecha de Nacimiento y Nº de Historia Clínica.'); } };
  const openDeleteConfirm = (psy) => { setPsyToDelete(psy); };
  const confirmDeletePsychiatrist = () => { if (psyToDelete) { handleDeletePsychiatrist(psyToDelete.id); setPsyToDelete(null); } };

  return (
    <div className="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8">
        <header className="flex flex-wrap justify-between items-center gap-4 mb-6 pb-4 border-b border-slate-200">
            <div><h1 className="text-3xl font-bold text-slate-800">ELIMENTAL</h1><p className="text-md text-slate-500">Agenda de Psiquiatras</p></div>
            <div className="flex gap-2"><Button variant="secondary" onClick={() => setIsPatientModalOpen(true)}><Icon path={ICONS.USER_PLUS} className="w-5 h-5 mr-2" />Añadir Paciente</Button><Button onClick={() => openPsyModal(null)}><Icon path={ICONS.PLUS} className="w-5 h-5 mr-2" />Añadir Psiquiatra</Button></div>
        </header>
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 mt-2">
            <aside className="lg:col-span-4 xl:col-span-3"><MonthCalendar selectedDate={selectedDate} onDateSelect={setSelectedDate} /></aside>
            <div className="lg:col-span-8 xl:col-span-9 space-y-4">
                {psychiatrists.map((psy) => (<div key={psy.id} className="bg-white rounded-lg shadow-md"><div className="flex justify-between items-center p-4 cursor-pointer" onClick={() => handleToggle(psy.id)}><div className="flex items-center"><Icon path={ICONS.USER} className="w-8 h-8 mr-4 text-primary-500" /><div><p className="text-xl font-semibold text-slate-700">{psy.name}</p><p className="text-sm font-normal text-primary-600">{psy.specialty}</p></div></div><div className="flex items-center gap-2"><Button variant="secondary" className="p-2 h-9 w-9 !rounded-full" onClick={(e) => { e.stopPropagation(); openPsyModal(psy); }} title="Editar psiquiatra"><Icon path={ICONS.PENCIL} className="w-4 h-4" /></Button><Button variant="danger-secondary" className="p-2 h-9 w-9 !rounded-full" onClick={(e) => { e.stopPropagation(); openDeleteConfirm(psy); }} title="Eliminar psiquiatra"><Icon path={ICONS.TRASH} className="w-4 h-4" /></Button><Icon path={expandedId === psy.id ? ICONS.CHEVRON_UP : ICONS.CHEVRON_DOWN} className="w-7 h-7 text-slate-400" /></div></div>{expandedId === psy.id && <CalendarView psychiatristId={psy.id} onAddAppointment={openAptModal} selectedDate={selectedDate} onDateChange={setSelectedDate} />}</div>))}
            </div>
        </div>
        <Modal isOpen={isPsyModalOpen} onClose={() => setIsPsyModalOpen(false)} title={editingPsychiatrist ? "Editar Psiquiatra" : "Añadir Psiquiatra"}><div className="space-y-4"><div><label htmlFor="name" className="block text-sm font-medium text-gray-700">Nombre completo</label><input type="text" id="name" name="name" value={psyFormData.name} onChange={handlePsyFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md" placeholder="Dr. Nombre Apellido"/></div><div><label htmlFor="specialty" className="block text-sm font-medium text-gray-700">Especialidad</label><select id="specialty" name="specialty" value={psyFormData.specialty} onChange={handlePsyFormChange} className="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-primary-500 focus:border-primary-500 sm:text-sm rounded-md">{PSYCHIATRIST_SPECIALTIES.map(s => <option key={s} value={s}>{s}</option>)}</select></div></div><div className="mt-6 flex justify-end"><Button onClick={handleSavePsychiatrist}>Guardar</Button></div></Modal>
        <Modal isOpen={isPatientModalOpen} onClose={() => setIsPatientModalOpen(false)} title="Añadir Nuevo Paciente"><div className="space-y-4 max-h-[60vh] overflow-y-auto pr-2"><div className="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label htmlFor="patName">Nombre</label><input type="text" id="patName" name="name" value={newPatientData.name} onChange={handlePatientFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div><div><label htmlFor="patDob">F. Nacimiento</label><input type="date" id="patDob" name="dateOfBirth" value={newPatientData.dateOfBirth} onChange={handlePatientFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div><div><label htmlFor="patNhc">Nº H. Clínica</label><input type="text" id="patNhc" name="clinicalHistoryNumber" value={newPatientData.clinicalHistoryNumber} onChange={handlePatientFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div><div><label htmlFor="patInsurance">Seguro</label><input type="text" id="patInsurance" name="insurance" value={newPatientData.insurance} onChange={handlePatientFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div></div><div><label htmlFor="patAddress">Domicilio</label><input type="text" id="patAddress" name="address" value={newPatientData.address} onChange={handlePatientFormChange} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div><div><label htmlFor="patMHH">A. S. Mental</label><textarea id="patMHH" name="mentalHealthHistory" value={newPatientData.mentalHealthHistory} onChange={handlePatientFormChange} rows={3} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div><div><label htmlFor="patBS">S. Basal</label><textarea id="patBS" name="baselineSituation" value={newPatientData.baselineSituation} onChange={handlePatientFormChange} rows={3} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div><div><label htmlFor="patSU">Tóxicos</label><textarea id="patSU" name="substanceUse" value={newPatientData.substanceUse} onChange={handlePatientFormChange} rows={3} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div></div><div className="mt-6 flex justify-end"><Button onClick={handleSaveNewPatient}>Guardar Paciente</Button></div></Modal>
        <Modal isOpen={isAptModalOpen} onClose={() => setIsAptModalOpen(false)} title="Añadir Nueva Cita">{newAptData && (<div className="space-y-4"><div><label htmlFor="aptPatient">Paciente</label><select id="aptPatient" value={newAptData.patientId} onChange={(e) => setNewAptData({...newAptData, patientId: e.target.value})} className="mt-1 block w-full pl-3 pr-10 py-2 border-gray-300 focus:ring-primary-500 rounded-md"><option value="" disabled>Seleccione un paciente</option>{patients.map(p => <option key={p.id} value={p.id}>{p.name}</option>)}</select></div><div><label htmlFor="aptTime">Hora</label><input type="time" id="aptTime" value={newAptData.time} onChange={(e) => setNewAptData({...newAptData, time: e.target.value})} className="mt-1 w-full p-2 border border-slate-300 rounded-md"/></div><div className="mt-6 flex justify-end"><Button onClick={handleNewAptSubmit}>Guardar Cita</Button></div></div>)}</Modal>
        <Modal isOpen={!!psyToDelete} onClose={() => setPsyToDelete(null)} title="Confirmar Eliminación">{psyToDelete && (<div><p>¿Seguro que desea eliminar a <strong>{psyToDelete.name}</strong>?</p><p className="mt-2 text-sm text-red-600">Esta acción eliminará todas sus citas.</p><div className="mt-6 flex justify-end gap-2"><Button variant="secondary" onClick={() => setPsyToDelete(null)}>Cancelar</Button><Button variant="danger" onClick={confirmDeletePsychiatrist}>Confirmar</Button></div></div>)}</Modal>
    </div>
  );
};

const App = () => {
    const [appData, setAppData] = useState(null);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);
    const [currentView, setCurrentView] = useState('agenda');
    const [selectedPatientId, setSelectedPatientId] = useState(null);

    const API_URL = '/api/data';

    useEffect(() => {
        fetch(API_URL)
            .then(res => {
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })
            .then(data => {
                setAppData(data);
            })
            .catch(err => {
                console.error("Error al cargar los datos:", err);
                setError("No se pudieron cargar los datos del servidor. Por favor, asegúrese de que el servidor está funcionando en su NAS y recargue la página.");
            })
            .finally(() => {
                setIsLoading(false);
            });
    }, []);
    
    const saveData = useCallback((newData) => {
        // Optimistic update for a snappy UI
        setAppData(newData);

        fetch(API_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newData)
        }).catch(err => {
            console.error("Error al guardar los datos:", err);
            setError("Error al guardar los datos. Sus últimos cambios podrían no ser permanentes.");
            // Note: A more robust app might revert the optimistic update here
        });
    }, []);

    const handleSelectPatient = (patientId) => { setSelectedPatientId(patientId); setCurrentView('patient'); };
    const handleReturnToAgenda = () => { setSelectedPatientId(null); setCurrentView('agenda'); };
    
    const handleUpdatePatient = (updatedPatient) => {
        const updatedPatients = appData.patients.map(p => p.id === updatedPatient.id ? updatedPatient : p);
        saveData({ ...appData, patients: updatedPatients });
    };
    
    const selectedPatient = useMemo(() => {
        return currentView === 'patient' && selectedPatientId && appData ? appData.patients.find(p => p.id === selectedPatientId) : null;
    }, [currentView, selectedPatientId, appData]);

    if (isLoading) {
        return <div className="flex justify-center items-center h-screen text-xl text-slate-600 font-semibold">Cargando datos de la clínica...</div>;
    }
    
    if (error) {
        return <div className="flex justify-center items-center h-screen text-center p-8"><div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong className="font-bold">Error de Conexión.</strong><span className="block sm:inline ml-2">{error}</span></div></div>;
    }

    if (!appData) {
        return null; // Should not happen if loading and error states are handled
    }

    return (
        <main className="min-h-screen bg-slate-50 text-slate-900">
            {currentView === 'agenda' ? (
                <PsychiatristAgenda appData={appData} onDataChange={saveData} onSelectPatient={handleSelectPatient} />
            ) : selectedPatient ? (
                <PatientView patient={selectedPatient} onUpdatePatient={handleUpdatePatient} onBack={handleReturnToAgenda} />
            ) : (
                <div className="flex justify-center items-center h-screen"><div><p className="text-xl text-red-600">Error: Paciente no encontrado.</p>{(() => { setTimeout(() => handleReturnToAgenda(), 2000); return null; })()}</div></div>
            )}
        </main>
    );
};

// --- RENDER THE APP ---
const rootElement = document.getElementById('root');
const root = ReactDOM.createRoot(rootElement);
root.render(<App />);

    </script>
<script type="module" src="/index.tsx"></script>
</body>
</html>